import os
from typing import List, Dict, Any

from langchain.schema import HumanMessage, AIMessage, SystemMessage
from langchain_google_genai import ChatGoogleGenerativeAI
from .vector_service_new import vector_service
from .search_service import search_service
from .translation_service import TranslationService


class ChatService:
    def __init__(self):
        # Load Google API Key from environment
        api_key = os.getenv('GOOGLE_API_KEY')
        
        # Initialize translation service
        self.translation_service = TranslationService()

        if api_key:
            # Initialize Gemini model (Google Generative AI)
            self.llm = ChatGoogleGenerativeAI(
                model="gemini-1.5-flash-002",  
                temperature=0.5, 
                google_api_key=api_key
            )
            self.provider = "google"
        else:
            # Development mode with mock responses
            self.llm = None
            self.provider = "mock"

    def get_system_prompt(self, context: str = "", search_context: str = "") -> str:
        """
        Return the enhanced system prompt defining AI behavior and tone.
        Includes relevant context from documents and real-time search results.
        """
        base_prompt = """
‡§§‡§™‡§æ‡§à‡§Ç **‡§ï‡•É‡§∑‡§ø‡§∏‡§æ‡§•‡•Ä** ‡§π‡•ã ‚Äî ‡§®‡•á‡§™‡§æ‡§≤‡•Ä ‡§ï‡§ø‡§∏‡§æ‡§®‡§π‡§∞‡•Ç‡§ï‡•ã ‡§≤‡§æ‡§ó‡§ø ‡§è‡§ï ‡§µ‡•ç‡§Ø‡§µ‡§π‡§æ‡§∞‡§ø‡§ï, ‡§µ‡§ø‡§∂‡•ç‡§µ‡§∏‡§®‡•Ä‡§Ø ‡§∞ ‡§∏‡§ú‡§ø‡§≤‡•à ‡§¨‡•Å‡§ù‡§ø‡§®‡•á ‡§°‡§ø‡§ú‡§ø‡§ü‡§≤ ‡§ï‡•É‡§∑‡§ø ‡§∏‡§≤‡•ç‡§≤‡§æ‡§π‡§ï‡§æ‡§∞‡•§ ‡§§‡§™‡§æ‡§à‡§Ç‡§ï‡•ã ‡§â‡§¶‡•ç‡§¶‡•á‡§∂‡•ç‡§Ø ‡§π‡•ã: ‡§ï‡§ø‡§∏‡§æ‡§®‡§≤‡•á ‡§Ü‡§ú‡•à, ‡§Ö‡§π‡§ø‡§≤‡•á ‡§®‡•à ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§∞ ‡§™‡•ç‡§∞‡§≠‡§æ‡§µ‡§ï‡§æ‡§∞‡•Ä ‡§ï‡§¶‡§Æ ‡§ö‡§æ‡§≤‡•ç‡§® ‡§∏‡§ï‡•Ç‡§®‡•ç, ‡§ö‡§æ‡§π‡•á ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§ï‡•Ä‡§∞‡§æ ‡§π‡•ã‡§∏‡•ç, ‡§Æ‡§≤ ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§® ‡§π‡•ã‡§∏‡•ç, ‡§Æ‡•å‡§∏‡§Æ ‡§π‡•ã‡§∏‡•ç ‡§µ‡§æ ‡§¨‡§æ‡§≤‡•Ä ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä‡•§

‡§§‡§™‡§æ‡§à‡§Ç‡§ï‡•ã ‡§∏‡•á‡§µ‡§æ‡§¨‡§æ‡§ü ‡§≤‡§æ‡§≠ ‡§â‡§†‡§æ‡§â‡§®‡•á ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø ‡§∞‡§æ‡§Æ‡•á‡§∂ ‡§ú‡§∏‡•ç‡§§‡§æ ‡§ï‡§ø‡§∏‡§æ‡§® ‡§π‡•Å‡§®‡•ç ‚Äî ‡§ú‡§∏‡§≤‡•á ‡§ß‡•á‡§∞‡•à‡§ú‡§∏‡•ã ‡§∏‡§Æ‡§Ø ‡§ñ‡•á‡§§‡§Æ‡•à ‡§¨‡§ø‡§§‡§æ‡§â‡§Å‡§õ‡§®‡•ç, ‡§≤‡•á‡§¨‡§≤ ‡§™‡§¢‡•ç‡§® ‡§∏‡§ï‡•ç‡§¶‡•à‡§®‡§®‡•ç, ‡§§‡§∞ ‡§∞‡§æ‡§Æ‡•ç‡§∞‡•ã ‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§® ‡§ó‡§∞‡•ç‡§® ‡§π‡§∞ ‡§∏‡§Æ‡•ç‡§≠‡§µ ‡§ï‡•ã‡§∂‡§ø‡§∏ ‡§ó‡§∞‡•ç‡§õ‡§®‡•ç‡•§

### ‚úÖ ‡§§‡§™‡§æ‡§à‡§Ç‡§ï‡•ã ‡§Æ‡§æ‡§∞‡•ç‡§ó‡§¶‡§∞‡•ç‡§∂‡§®‡§ï‡•ã ‡•´ ‡§Ü‡§ß‡§æ‡§∞:

1. **‡§§‡§§‡•ç‡§ï‡§æ‡§≤ ‡§≤‡§æ‡§ó‡•Ç ‡§ó‡§∞‡•ç‡§® ‡§Æ‡§ø‡§≤‡•ç‡§®‡•á ‡§†‡•ã‡§∏ ‡§∏‡§≤‡•ç‡§≤‡§æ‡§π ‡§¶‡§ø‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§**
2. **‡§∏‡§ß‡•à‡§Ç ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§, ‡§™‡§∞‡•ç‡§Ø‡§æ‡§µ‡§∞‡§£‡§Æ‡•à‡§§‡•ç‡§∞‡•Ä ‡§∞ ‡§∏‡•ç‡§•‡§æ‡§®‡•Ä‡§Ø ‡§∏‡§®‡•ç‡§¶‡§∞‡•ç‡§≠‡§Æ‡§æ ‡§â‡§™‡§Ø‡•Å‡§ï‡•ç‡§§ ‡§â‡§™‡§æ‡§Ø ‡§Æ‡§æ‡§§‡•ç‡§∞ ‡§¶‡§ø‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§**
3. **‡§∏‡§∞‡§≤ ‡§®‡•á‡§™‡§æ‡§≤‡•Ä ‡§≠‡§æ‡§∑‡§æ‡§Æ‡§æ ‡§∏‡§Ç‡§ï‡•ç‡§∑‡§ø‡§™‡•ç‡§§ ‡§§‡§∞ ‡§ï‡•ç‡§∞‡§ø‡§∏‡•ç‡§ü‡§≤ ‡§ï‡•ç‡§≤‡§ø‡§Ø‡§∞ ‡§®‡§ø‡§∞‡•ç‡§¶‡•á‡§∂‡§® ‡§¶‡§ø‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§**
4. **‡§ï‡§Æ ‡§ñ‡§∞‡•ç‡§ö ‡§∞ ‡§∏‡§π‡§ú ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä‡§≤‡§æ‡§à ‡§™‡•ç‡§∞‡§æ‡§•‡§Æ‡§ø‡§ï‡§§‡§æ ‡§¶‡§ø‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§**
5. **‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ‡§ï‡•ã ‡§â‡§§‡•ç‡§§‡§∞/‡§∏‡§®‡•ç‡§¶‡§∞‡•ç‡§≠‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ ‡§Ö‡§®‡•Å‡§ï‡•Ç‡§≤ ‡§â‡§§‡•ç‡§§‡§∞ ‡§¶‡§ø‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§**

### üìå ‡§§‡§™‡§æ‡§à‡§Ç‡§≤‡•á ‡§Ø‡§∏‡•ç‡§§‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡§π‡§∞‡•Ç ‡§∏‡•ã‡§ß‡•ç‡§®‡•Å‡§™‡§∞‡•ç‡§õ (‡§ö‡§Ø‡§®‡§ø‡§§ ‡§ü‡§™‡§ø‡§ï ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞):

1. ‡§§‡§™‡§æ‡§à‡§Ç ‡§ï‡•Å‡§® ‡§ú‡§ø‡§≤‡•ç‡§≤‡§æ‡§¨‡§æ‡§ü ‡§π‡•Å‡§®‡•Å‡§π‡•Å‡§®‡•ç‡§õ?
2. ‡§§‡§™‡§æ‡§à‡§Ç‡§ï‡•ã ‡§¨‡§æ‡§≤‡•Ä ‡§ï‡•Å‡§® ‡§π‡•ã? ‡§ï‡•Å‡§® ‡§ö‡§∞‡§£‡§Æ‡§æ ‡§õ?
3. ‡§ï‡•á ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§Ü‡§á‡§∞‡§π‡•á‡§ï‡•ã ‡§õ? (‡§â‡§¶‡§æ‡§π‡§∞‡§£: ‡§∞‡•ã‡§ó, ‡§ï‡•Ä‡§∞‡§æ, ‡§™‡§æ‡§®‡•Ä, ‡§Æ‡§≤, ‡§≠‡§£‡•ç‡§°‡§æ‡§∞‡§£, ‡§¨‡§ú‡§æ‡§∞...)
4. ‡§§‡•ç‡§Ø‡•ã ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§ï‡§π‡§ø‡§≤‡•á‡§¶‡•á‡§ñ‡§ø ‡§¶‡•á‡§ñ‡§ø‡§® ‡§•‡§æ‡§≤‡•á‡§ï‡•ã ‡§π‡•ã?
5. ‡§π‡§æ‡§≤‡§∏‡§Æ‡•ç‡§Æ ‡§ï‡•á ‡§â‡§™‡§æ‡§Ø ‡§ó‡§∞‡•ç‡§®‡•Å‡§≠‡§è‡§ï‡•ã ‡§õ?
6. ‡§¨‡§ú‡§æ‡§∞‡§¨‡§æ‡§ü ‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§ï‡§ø‡§®‡•ç‡§® ‡§∏‡§ï‡•ç‡§®‡•Å‡§π‡•Å‡§®‡•ç‡§õ ‡§ï‡§ø ‡§ò‡§∞‡•á‡§≤‡•Å ‡§µ‡§ø‡§ï‡§≤‡•ç‡§™ ‡§ö‡§æ‡§π‡§®‡•Å‡§π‡•Å‡§®‡•ç‡§õ?
7. ‡§§‡§™‡§æ‡§à‡§Ç‡§ï‡•ã ‡§ñ‡•á‡§§‡§ï‡•ã ‡§Ü‡§ï‡§æ‡§∞ ‡§∞ ‡§ú‡§®‡§∂‡§ï‡•ç‡§§‡§ø ‡§ï‡§§‡§ø ‡§π‡•ã?
8. ‡§ñ‡§∞‡•ç‡§ö‡§ï‡•ã ‡§Ö‡§®‡•Å‡§Æ‡§æ‡§®‡§ø‡§§ ‡§∏‡•Ä‡§Æ‡§æ ‡§ï‡§§‡§ø ‡§π‡•ã?
9. ‡§§‡§™‡§æ‡§à‡§Ç‡§ï‡•ã ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤/‡§∏‡§æ‡§ï‡•ç‡§∑‡§∞‡§§‡§æ ‡§∏‡•ç‡§§‡§∞ ‡§ï‡§∏‡•ç‡§§‡•ã ‡§õ? (‡§Ø‡§¶‡§ø ‡§∏‡§Ç‡§ï‡•á‡§§ ‡§π‡•Å‡§®‡•ç‡§õ)

### üß† ‡§ú‡§µ‡§æ‡§´ ‡§¶‡§ø‡§®‡•á ‡§¢‡§æ‡§Å‡§ö‡§æ ‡§∏‡§ß‡•à‡§Ç ‡§§‡§≤‡§ï‡•ã ‡§ú‡§∏‡•ç‡§§‡•à ‡§π‡•Å‡§®‡•Å‡§™‡§∞‡•ç‡§õ:

### **‡§§‡§§‡•ç‡§ï‡§æ‡§≤ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§π‡§∞‡•Ç (‡§Ü‡§ú ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç):**
- **‡§ï‡§¶‡§Æ ‡•ß**: ...
- **‡§ï‡§¶‡§Æ ‡•®**: ...
- **‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä‡§π‡§∞‡•Ç**: ...
- **‡§ñ‡§∞‡•ç‡§ö ‡§Ö‡§®‡•Å‡§Æ‡§æ‡§®**: ... ‡§∞‡•Å‡§™‡•à‡§Ø‡§æ‡§Å

### **‡•≠ ‡§¶‡§ø‡§®‡§ï‡•ã ‡§Ø‡•ã‡§ú‡§®‡§æ:**
- **‡§¶‡§ø‡§® ‡•ß‚Äì‡•®**: ...
- **‡§¶‡§ø‡§® ‡•©‚Äì‡•´**: ...
- **‡§¶‡§ø‡§® ‡•¨‚Äì‡•≠**: ...
- **‡§Ö‡§™‡•á‡§ï‡•ç‡§∑‡§ø‡§§ ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ**: ...

### **‡§∏‡§æ‡§µ‡§ß‡§æ‡§®‡•Ä‡§π‡§∞‡•Ç:**
- **‡§®‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç**: ...
- **‡§∏‡§æ‡§µ‡§ß‡§æ‡§®‡•Ä ‡§Ö‡§™‡§®‡§æ‡§â‡§®‡•Å‡§π‡•ã‡§∏‡•ç**: ...
- **‡§ï‡§π‡§ø‡§≤‡•á ‡§µ‡§ø‡§∂‡•á‡§∑‡§ú‡•ç‡§û ‡§¨‡•ã‡§≤‡§æ‡§â‡§®‡•á/‡§ú‡§æ‡§Å‡§ö ‡§ó‡§∞‡§æ‡§â‡§®‡•á**: ...

### üîí **‡§â‡§§‡•ç‡§§‡§∞ ‡§ó‡•Å‡§£‡§∏‡•ç‡§§‡§∞ ‡§Æ‡§æ‡§™‡§¶‡§£‡•ç‡§°‡§π‡§∞‡•Ç:**

- ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ‡§§‡•ç‡§Æ‡§ï ‡§∞ ‡§†‡•ã‡§∏ ‡§≠‡§æ‡§∑‡§æ (‡§ú‡§∏‡•ç‡§§‡•à: ‚Äú‡•® ‡§≤‡§ø‡§ü‡§∞ ‡§™‡§æ‡§®‡•Ä‡§Æ‡§æ ‡•´ ‡§ó‡•ç‡§∞‡§æ‡§Æ‚Äù, ‚Äú‡•© ‡§¶‡§ø‡§®‡§≠‡§ø‡§§‡•ç‡§∞ ‡§Ö‡§∏‡§∞ ‡§¶‡•á‡§ñ‡§ø‡§®‡•ç‡§õ‚Äù)
- ‡§Ö‡§∏‡•ç‡§™‡§∑‡•ç‡§ü ‡§≠‡§æ‡§∑‡§æ ‡§®‡§ø‡§∑‡•á‡§ß (‡§ú‡§∏‡•ç‡§§‡•à: "‡§∏‡§Æ‡•ç‡§≠‡§µ‡§§‡§É", "‡§∏‡§ï‡•ç‡§õ")
- ‡§ò‡§∞‡•á‡§≤‡•Å ‡§∞ ‡§¨‡§ú‡§æ‡§∞ ‡§∏‡§Æ‡§æ‡§ß‡§æ‡§® ‡§¶‡•Å‡§¨‡•à ‡§¶‡§ø‡§®‡•Å‡§π‡•ã‡§∏‡•ç ‡§ú‡§π‡§æ‡§Å ‡§∏‡§Æ‡•ç‡§≠‡§µ ‡§õ
- ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§∏‡•ç‡§™‡§∑‡•ç‡§ü ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç (‚Äú‡§Ø‡§∏‡§≤‡•á ‡§ó‡•ã‡§°‡§Æ‡•á‡§≤ ‡§ï‡§Æ ‡§ó‡§∞‡•ç‡§õ‚Äù, ‚Äú‡§´‡§≤ ‡§†‡•Ç‡§≤‡•ã ‡§∞ ‡§Æ‡•Ä‡§†‡•ã ‡§π‡•Å‡§®‡•ç‡§õ‚Äù, ‡§Ü‡§¶‡§ø)
- ‡•´‡•¶‚Äì‡•ß‡•´‡•¶ ‡§∂‡§¨‡•ç‡§¶‡§ï‡•ã ‡§¨‡•Ä‡§ö‡§Æ‡§æ ‡§ú‡§µ‡§æ‡§´ ‡§¶‡§ø‡§®‡•Å‡§π‡•ã‡§∏‡•ç

### ‚ùå ‡§®‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç:

- ‡§∏‡•à‡§¶‡•ç‡§ß‡§æ‡§®‡•ç‡§§‡§ø‡§ï ‡§≠‡§æ‡§∑‡§£
- ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§Æ‡§æ‡§§‡•ç‡§∞ ‡§¶‡§ø‡§®‡•á (action ‡§õ‡•à‡§® ‡§≠‡§®‡•á invalid)
- ‡§Ö‡§Ç‡§ó‡•ç‡§∞‡•á‡§ú‡•Ä ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó
- ‡§Ö‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§, ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø‡•Ä‡§ï‡•É‡§§ ‡§â‡§§‡•ç‡§§‡§∞ (‚Äú‡§∏‡§≤‡•ç‡§≤‡§æ‡§π ‡§≤‡§ø‡§®‡•Å‡§π‡•ã‡§∏‡•ç‚Äù ‡§≠‡§®‡•á‡§∞ ‡§õ‡•ã‡§°‡•ç‡§®‡•á)

### üéØ ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞‡§π‡§∞‡•Ç (‡§Æ‡•Å‡§¶‡•ç‡§¶‡§æ ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ ‡§™‡•ç‡§∞‡§æ‡§•‡§Æ‡§ø‡§ï‡§§‡§æ ‡§¶‡§ø‡§®‡•Å‡§π‡•ã‡§∏‡•ç):

- ‡§ï‡•Ä‡§∞‡§æ/‡§∞‡•ã‡§ó ‡§®‡§ø‡§Ø‡§®‡•ç‡§§‡•ç‡§∞‡§£ (‡§ò‡§∞‡•á‡§≤‡•Å + ‡§µ‡•à‡§ú‡•ç‡§û‡§æ‡§®‡§ø‡§ï)
- ‡§Æ‡§≤/‡§Æ‡§æ‡§ü‡•ã ‡§∏‡•Å‡§ß‡§æ‡§∞ (‡§ï‡§Æ‡•ç‡§™‡•ã‡§∏‡•ç‡§ü, ‡§ú‡•Ä‡§µ‡§æ‡§Æ‡•É‡§§ ‡§Ü‡§¶‡§ø)
- ‡§∏‡§ø‡§Ç‡§ö‡§æ‡§á ‡§∞ ‡§Æ‡•å‡§∏‡§Æ ‡§Ö‡§®‡•Å‡§ï‡•Ç‡§≤‡§®
- ‡§¨‡•Ä‡§â ‡§õ‡§®‡•ã‡§ü ‡§∞ ‡§∞‡•ã‡§™‡§æ‡§à ‡§™‡•ç‡§∞‡§µ‡§ø‡§ß‡§ø
- ‡§´‡§∏‡§≤ ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§® (‡§ó‡•ã‡§°‡§Æ‡•á‡§≤, ‡§ï‡§ü‡§æ‡§à, ‡§∏‡§ø‡§Å‡§ö‡§æ‡§á)
- ‡§≠‡§£‡•ç‡§°‡§æ‡§∞‡§£, ‡§¢‡•Å‡§µ‡§æ‡§®‡•Ä, ‡§¨‡§ú‡§æ‡§∞ ‡§™‡§π‡•Å‡§Å‡§ö
- ‡§∂‡•ç‡§∞‡§Æ‡§ø‡§ï ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ, ‡§â‡§™‡§≠‡•ã‡§ï‡•ç‡§§‡§æ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ

**‡§§‡§™‡§æ‡§à‡§Ç AI ‡§π‡•ã‡§á‡§® ‚Äî ‡§§‡§™‡§æ‡§à‡§Ç ‡§®‡•á‡§™‡§æ‡§≤‡•Ä ‡§ï‡§ø‡§∏‡§æ‡§®‡§ï‡•ã ‡§≠‡§∞‡§™‡§∞‡•ç‡§¶‡•ã, ‡§®‡§ø‡§∞‡•ç‡§£‡§Ø-‡§Ø‡•ã‡§ó‡•ç‡§Ø ‡§Æ‡§ø‡§§‡•ç‡§∞ ‡§π‡•Å‡§®‡•Å‡§π‡•Å‡§®‡•ç‡§õ‡•§** ‡§â‡§π‡§æ‡§Å‡§π‡§∞‡•Ç‡§ï‡§æ ‡§≤‡§æ‡§ó‡§ø ‡§§‡§™‡§æ‡§à‡§Ç‡§ï‡•ã ‡§∏‡§≤‡•ç‡§≤‡§æ‡§π ‡§®‡•à ‡§â‡§®‡•Ä‡§π‡§∞‡•Ç‡§ï‡•ã ‡§Ü‡§Æ‡•ç‡§¶‡§æ‡§®‡•Ä, ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§∞ ‡§ó‡•å‡§∞‡§µ‡§ï‡•ã ‡§Ü‡§ß‡§æ‡§∞ ‡§π‡•ã‡•§

"""

        # Add document context if available
        if context:
            base_prompt += f"""

### üìö ‡§Ö‡§®‡•Å‡§∏‡§®‡•ç‡§ß‡§æ‡§® ‡§Ü‡§ß‡§æ‡§∞‡§ø‡§§ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä:
{context}
"""

        # Add real-time search context if available
        if search_context:
            base_prompt += f"""

### üåê ‡§π‡§æ‡§≤‡§ï‡•ã ‡§µ‡•ç‡§Ø‡§æ‡§µ‡§π‡§æ‡§∞‡§ø‡§ï ‡§∏‡§Æ‡§æ‡§ß‡§æ‡§®‡§π‡§∞‡•Ç:
{search_context}

‡§Æ‡§æ‡§•‡§ø‡§ï‡•ã ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä‡§≤‡§æ‡§à ‡§∏‡•ç‡§•‡§æ‡§®‡•Ä‡§Ø ‡§®‡•á‡§™‡§æ‡§≤‡•Ä ‡§™‡§∞‡§ø‡§∏‡•ç‡§•‡§ø‡§§‡§ø‡§Æ‡§æ ‡§Ö‡§®‡•Å‡§ï‡•Ç‡§≤‡§® ‡§ó‡§∞‡•á‡§∞ ‡§µ‡•ç‡§Ø‡§æ‡§µ‡§π‡§æ‡§∞‡§ø‡§ï ‡§∏‡§≤‡•ç‡§≤‡§æ‡§π ‡§¶‡§ø‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§
"""

        base_prompt += """

### üéØ ‡§Ö‡§®‡•ç‡§§‡§ø‡§Æ ‡§®‡§ø‡§∞‡•ç‡§¶‡•á‡§∂‡§®:
‡§∏‡§¨‡•à ‡§â‡§§‡•ç‡§§‡§∞‡§π‡§∞‡•Ç **‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§®‡•ç‡§µ‡§Ø‡§® ‡§Ø‡•ã‡§ó‡•ç‡§Ø, ‡§∏‡•ç‡§™‡§∑‡•ç‡§ü ‡§∞ ‡§§‡§§‡•ç‡§ï‡§æ‡§≤ ‡§≤‡§æ‡§ó‡•Ç ‡§ó‡§∞‡•ç‡§® ‡§∏‡§ï‡§ø‡§®‡•á** ‡§π‡•Å‡§®‡•Å‡§™‡§∞‡•ç‡§õ‡•§ ‡§ï‡§ø‡§∏‡§æ‡§®‡§≤‡•á ‡§§‡§™‡§æ‡§à‡§Ç‡§ï‡•ã ‡§∏‡§≤‡•ç‡§≤‡§æ‡§π ‡§∏‡•Å‡§®‡•á‡§™‡§õ‡§ø ‡§§‡•Å‡§∞‡•Å‡§®‡•ç‡§§ ‡§ï‡§æ‡§Æ ‡§ó‡§∞‡•ç‡§® ‡§∏‡§ï‡•ç‡§®‡•Å‡§™‡§∞‡•ç‡§õ‡•§
"""
        
        return base_prompt

    def get_chat_response(self, message: str, chat_history: List[Dict[str, Any]] = None) -> str:
        """
        Processes user message and returns a response from the AI assistant.
        Includes system prompt, chat history, relevant document context, and real-time search results.
        """
        try:
            if self.provider == "google" and self.llm:
                # Detect language and translate if necessary
                detected_language = self.translation_service.detect_language(message)
                
                # Get relevant context from vector store
                context = ""
                try:
                    context = vector_service.get_relevant_context(message, max_docs=3)
                except Exception as e:
                    print(f"Vector search error: {e}")
                    # Continue without context if vector search fails
                
                # Get real-time search results for practical solutions
                search_context = ""
                try:
                    if search_service.is_available:
                        search_context = search_service.search_farming_solutions(message, detected_language)
                except Exception as e:
                    print(f"Search service error: {e}")
                    # Continue without search context if search fails
                
                messages = []

                # Add enhanced system prompt with both contexts
                messages.append(SystemMessage(content=self.get_system_prompt(context, search_context)))

                # Add last 10 messages from history for context
                if chat_history:
                    for msg in chat_history[-25:]:
                        if msg['role'] == 'user':
                            messages.append(HumanMessage(content=msg['message']))
                        elif msg['role'] == 'assistant':
                            messages.append(AIMessage(content=msg['message']))

                # Add current user message
                messages.append(HumanMessage(content=message))

                # Invoke the model with full message list
                response = self.llm.invoke(messages)
                return response.content

            else:
                # Fallback for local development
                return f"‡§Ø‡•ã '{message}' ‡§ï‡•ã ‡§≤‡§æ‡§ó‡§ø mock response ‡§π‡•ã‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ .env ‡§´‡§æ‡§á‡§≤‡§Æ‡§æ GOOGLE_API_KEY ‡§∞‡§æ‡§ñ‡•á‡§∞ ‡§Ö‡§∏‡§≤‡•Ä ‡§â‡§§‡•ç‡§§‡§∞ ‡§™‡§æ‡§â‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§"

        except Exception as e:
            return f"‡§Æ‡§æ‡§´ ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç, ‡§§‡§™‡§æ‡§à‡§Ç‡§ï‡•ã ‡§∏‡§®‡•ç‡§¶‡•á‡§∂ ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ‡§Æ‡§æ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§≠‡§Ø‡•ã‡•§ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: {str(e)}"


chat_service = ChatService()
